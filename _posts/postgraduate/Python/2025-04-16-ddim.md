---
layout: post
title: "ä»DDPMåˆ°DDIM"
date: 2025-04-16 09:00:00 +0800
categories: ç ”ç©¶ç”Ÿæ¶¯
tag: Python
---

æœ¬æ–‡æ·±å…¥è§£æ **DDPMï¼ˆæ‰©æ•£æ¦‚ç‡æ¨¡å‹ï¼‰** å’Œ **DDIMï¼ˆå»å™ªæ‰©æ•£éšå¼æ¨¡å‹ï¼‰** çš„æ ¸å¿ƒåŸç†ä¸æ¨å¯¼è¿‡ç¨‹ã€‚ä»DDPMçš„å‰å‘æ‰©æ•£ä¸åå‘ç”Ÿæˆå‡ºå‘ï¼Œé€æ­¥è¿‡æ¸¡åˆ°DDIMçš„ç¡®å®šæ€§é‡‡æ ·æ–¹æ³•ï¼Œè¯¦ç»†æ¨å¯¼å…¶æ•°å­¦å…¬å¼ï¼Œå¹¶å¯¹æ¯”ä¸¤è€…çš„å·®å¼‚ä¸ä¼˜åŠ¿ã€‚

<!-- more -->



# ä»DDPMåˆ°DDIM

[TOC]



------

## âœ… ä¸€ã€DDPMå›é¡¾ï¼šå‰å‘æ‰©æ•£ & åå‘ç”Ÿæˆ

æˆ‘ä»¬ä» DDPM çš„åŸºæœ¬æ„å»ºå‡ºå‘ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªè¿‡ç¨‹ï¼š

### 1. å‰å‘è¿‡ç¨‹ï¼ˆåŠ å™ªå£°ï¼‰ï¼š

æˆ‘ä»¬ä»çœŸå®å›¾åƒ $x_0 \sim q(x_0)$ï¼Œåœ¨æ¯ä¸ªæ—¶é—´æ­¥ $t$â€‹ å‘å…¶æ·»åŠ é«˜æ–¯å™ªå£°ï¼š
$$
q(x_t | x_{t-1}) = \mathcal{N}(x_t; \sqrt{1 - \beta_t} x_{t-1}, \beta_t \mathbf{I})
$$
å¯ä»¥ä¸€å£æ°”å†™å‡ºï¼š
$$
q(x_t | x_0) = \mathcal{N}(x_t; \sqrt{\bar{\alpha}_t} x_0, (1 - \bar{\alpha}_t) \mathbf{I})
$$
å…¶ä¸­ï¼š

- $\alpha_t = 1 - \beta_t$
- $\bar{\alpha_t}=\prod_{s=1}^{t}\alpha_s$

------

### 2. åå‘è¿‡ç¨‹ï¼ˆå»å™ªï¼‰ï¼š

DDPM è®­ç»ƒä¸€ä¸ªæ¨¡å‹é¢„æµ‹å™ªå£° $\epsilon_\theta(x_t, t)$â€‹ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹æ–¹å¼ä¸€æ­¥ä¸€æ­¥ç”Ÿæˆå›¾åƒï¼š
$$
p_\theta(x_{t-1} | x_t) = \mathcal{N}(x_{t-1}; \mu_\theta(x_t, t), \sigma_t^2 \mathbf{I})
$$
å…¶ä¸­ $\mu_\theta$ æ˜¯ä»é¢„æµ‹å™ªå£°å’Œ $x_t$ è®¡ç®—å‡ºçš„å‡å€¼ã€‚

------

## âœ… äºŒã€DDIM çš„æå‡ºï¼šä»éšæœº â†’ ç¡®å®šæ€§

DDPM çš„é‡‡æ ·è¿‡ç¨‹æ˜¯éšæœºçš„ï¼Œéœ€è¦é‡‡æ ·é«˜æ–¯å™ªå£°ã€‚DDIM æå‡ºä¸€ç§ **ç¡®å®šæ€§** çš„åå‘è¿‡ç¨‹ï¼ˆæ— éœ€æ¯æ­¥é‡‡æ ·å™ªå£°ï¼‰ï¼Œå¹¶å¯ä»¥â€œ**è·³æ­¥é‡‡æ ·**â€ï¼Œæé«˜æ•ˆç‡ã€‚

------

## âœ… ä¸‰ã€DDIMçš„æ¨å¯¼è¿‡ç¨‹

DDIM çš„é‡‡æ ·ä¸å†ç”¨éšæœºå˜é‡ï¼Œè€Œæ˜¯è®¾è®¡ä¸€ä¸ªæ–°çš„ç¡®å®šæ€§è¿‡ç¨‹ï¼š
$$
x_{t-1} = \sqrt{\bar{\alpha}_{t-1}} x_0 + \sqrt{1 - \bar{\alpha}_{t-1}} \cdot \eta
$$
å…¶ä¸­ $\eta$ æ˜¯æ§åˆ¶é‡‡æ ·è½¨è¿¹çš„å˜é‡ã€‚å…³é”®åœ¨äºæˆ‘ä»¬ä½¿ç”¨ç½‘ç»œé¢„æµ‹çš„å™ªå£° $\hat{\epsilon} = \epsilon_\theta(x_t, t)$ æ¥ä¼°è®¡ $x_0$ï¼š

------

### Step 1ï¼šä»é¢„æµ‹å™ªå£°æ¢å¤ $x_0$

æ ¹æ®å‰å‘è¿‡ç¨‹çš„è§£æå¼ï¼š
$$
x_t = \sqrt{\bar{\alpha}_t} x_0 + \sqrt{1 - \bar{\alpha}_t} \epsilon \Rightarrow x_0 = \frac{1}{\sqrt{\bar{\alpha}_t}} \left( x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon \right)
$$

------

### Step 2ï¼šé‡æ„ DDIM çš„é‡‡æ ·å…¬å¼

DDIM æ„é€ äº†å¦‚ä¸‹å½¢å¼çš„é‡‡æ ·è·¯å¾„ï¼ˆç¡®å®šæ€§ï¼‰ï¼š
$$
x_{t-1} = \sqrt{\bar{\alpha}_{t-1}} x_0 + \sqrt{1 - \bar{\alpha}_{t-1}} \cdot \epsilon_{\text{ddim}}
$$


ç„¶åå¼•å…¥ä¸€ä¸ª **é‡‡æ ·æ§åˆ¶å‚æ•°** $\eta \in [0, 1]$ï¼Œè¡¨ç¤ºé‡‡æ ·çš„â€œæ¸©åº¦â€æˆ–â€œéšæœºç¨‹åº¦â€ã€‚å½“ $\eta = 0$ æ—¶æ˜¯çº¯ç¡®å®šæ€§é‡‡æ ·ã€‚

æœ€ç»ˆï¼Œ**DDIMçš„é‡‡æ ·å…¬å¼**å¦‚ä¸‹ï¼š
$$
x_{t-1} = \sqrt{\bar{\alpha}_{t-1}} x_0 + \sqrt{1 - \bar{\alpha}_{t-1} - \eta^2 \sigma_t^2} \cdot \hat{\epsilon} + \eta \cdot \sigma_t \cdot z
$$
å…¶ä¸­ï¼š

- $x_0$ æ˜¯ä» $x_t$ å’Œ $\hat{\epsilon}$ åæ¨å‡ºæ¥çš„ï¼›
- $\hat{\epsilon} = \epsilon_\theta(x_t, t)$ æ˜¯æ¨¡å‹é¢„æµ‹çš„å™ªå£°ï¼›
- $\sigma_t^2$ æ˜¯ DDPM çš„åŸå§‹å™ªå£°ï¼›
- $z \sim \mathcal{N}(0, I)$ï¼Œå½“ $\eta = 0$ æ—¶ä¸åŠ å…¥å™ªå£°ï¼Œå°±æ˜¯ç¡®å®šæ€§é‡‡æ ·ã€‚

> âš ï¸ ä½ å¯ä»¥ç†è§£ä¸ºï¼šDDIM ç›¸å½“äºæ§åˆ¶å™ªå£°åŠ å…¥æ¯”ä¾‹ï¼Œè®©é‡‡æ ·å¯ä»¥å˜å¾—å¿«ã€ç¨³ï¼Œè¿˜å¯æ§ã€‚

------

## âœ… å››ã€$\eta$ ç‰¹æ®Šæƒ…å†µ

| $\eta$ å€¼      | æ•ˆæœ                         |
| -------------- | ---------------------------- |
| $\eta = 1$     | å°±æ˜¯åŸå§‹çš„ DDPM é‡‡æ ·ï¼ˆéšæœºï¼‰ |
| $\eta = 0$     | å®Œå…¨ç¡®å®šæ€§é‡‡æ ·ï¼ˆDDIM æ ¸å¿ƒï¼‰  |
| $0 < \eta < 1$ | åŠéšæœºï¼Œå¯è°ƒæ§é‡‡æ ·è·¯å¾„       |

------

## âœ… äº”ã€DDIM çš„ä¼˜åŠ¿

1. **é‡‡æ ·é€Ÿåº¦å¿«**ï¼šå¯ä»¥åªç”¨ 25~50 æ­¥å°±ç”Ÿæˆä¸é”™çš„å›¾åƒï¼ˆè€Œä¸æ˜¯ DDPM çš„ 1000 æ­¥ï¼‰ï¼›
2. **æ›´å¯æ§**ï¼šç”±äºæ˜¯ç¡®å®šæ€§çš„é‡‡æ ·è·¯å¾„ï¼Œå¯ä»¥åš interpolationã€å›¾åƒç¼–è¾‘ç­‰ï¼›
3. **å¯é€†è·¯å¾„**ï¼šDDIM çš„é‡‡æ ·è·¯å¾„æ˜¯å¯é€†çš„ï¼Œæœ‰åˆ©äºæ›´ç¨³å®šçš„å›¾åƒç”Ÿæˆã€‚

------

## âœ… å…­ã€æ€»ç»“

> DDIM æ˜¯åœ¨ä¿æŒç”Ÿæˆè´¨é‡çš„å‰æä¸‹ï¼ŒæŠŠ DDPM çš„éšæœºåå‘é‡‡æ ·å˜æˆäº†å¯æ§ã€å¯é€†çš„ç¡®å®šæ€§é‡‡æ ·ï¼Œæå‡äº†æ•ˆç‡ä¸ç¨³å®šæ€§ã€‚



------

# ğŸ§  DDIM é‡æ„é‡‡æ ·å…¬å¼æ¨å¯¼ç¬”è®°

## ä¸€ã€èƒŒæ™¯æ¦‚å¿µ

1. Markov å‡è®¾ï¼ˆæ ‡å‡† DDPMï¼‰ï¼Œæ‰©æ•£è¿‡ç¨‹æ»¡è¶³é©¬å°”å¯å¤«æ€§è´¨ï¼š

$$
p(x_{t-1} | x_t, x_0) \sim \text{Markov}
$$

ä½†åœ¨é‡‡æ ·é‡æ„æ—¶ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯ï¼š

$p(x_s \| x_k, x_0)$

> ç›®æ ‡æ˜¯æ„é€ ä¸€ä¸ªéé©¬å°”å¯å¤«çš„é‡‡æ ·è¿‡ç¨‹ï¼Œåœ¨ä¿æŒè¾¹ç¼˜åˆ†å¸ƒä¸å˜çš„åŒæ—¶ï¼Œå®ç°æ›´é«˜æ•ˆçš„é‡‡æ ·ã€‚

------

## äºŒã€åŸºæœ¬å…¬å¼æ„é€ 

æˆ‘ä»¬å¸Œæœ›é€šè¿‡å…¬å¼æ„é€ å‡ºï¼š
$$
p(x_s | x_k, x_0) \sim \mathcal{N}(\mu, \Sigma)
$$
ç”±å…¬å¼å±•å¼€ï¼š
$$
p(x_s | x_k, x_0) = \frac{p(x_k | x_s, x_0) \cdot p(x_s | x_0)}{p(x_k | x_0)}
$$
é‡ç‚¹åœ¨äºæ„é€  $x_s$ çš„æ˜¾å¼è¡¨è¾¾å¼ã€‚

------

## ä¸‰ã€æ¨å¯¼æ ¸å¿ƒéƒ¨åˆ†

å‡è®¾ä¸­é—´å™ªå£°é‡‡æ ·ï¼š
$$
x_k = \sqrt{\bar{\alpha}_k} x_0 + \sqrt{1 - \bar{\alpha}_k} \epsilon', \quad \epsilon' \sim \mathcal{N}(0, I)
$$
æˆ‘ä»¬å®šä¹‰ï¼š
$$
x_s = k x_0 + m x_k + \delta \epsilon
$$


å°† $x_k$ å¸¦å…¥ä¸Šå¼ï¼š
$$
x_s = k x_0 + m (\sqrt{\bar{\alpha}_k} x_0 + \sqrt{1 - \bar{\alpha}_k} \epsilon') + \delta \epsilon
$$
æ•´ç†å¾—åˆ°ï¼š
$$
x_s = (k + m\sqrt{\bar{\alpha}_k}) x_0 + m \sqrt{1 - \bar{\alpha}_k} \epsilon' + \delta \epsilon
$$
ç”±äº $\epsilon' \sim \mathcal{N}(0, I), \epsilon \sim \mathcal{N}(0, I)$â€‹ï¼Œåˆå¹¶ä¸¤é¡¹å™ªå£°ï¼Œå¾—åˆ°æ€»æ–¹å·®ï¼š
$$
x_s = \underbrace{(k + m\sqrt{\bar{\alpha}_k})}_{\sqrt{\bar{\alpha}_s}} x_0 + \underbrace{\sqrt{m^2(1 - \bar{\alpha}_k) + \delta^2}}_{\sqrt{1 - \bar{\alpha}_s}} \epsilon
$$


å®šä¹‰é‡‡æ ·ä¸­ç”¨åˆ°çš„ä¸­é—´å˜é‡ $m$ å’Œ $k$ï¼š

$$
m = \frac{\sqrt{1 - \bar{\alpha}_s} - \sigma^2}{\sqrt{1 - \bar{\alpha}_k}}, \quad
k = \frac{\sqrt{\bar{\alpha}_s} - \sqrt{1 - \bar{\alpha}_s - \sigma^2}}{\sqrt{1 - \bar{\alpha}_k}} \sqrt{\bar{\alpha}_k}
$$




é‡‡æ ·åˆ†å¸ƒä¸ºé«˜æ–¯åˆ†å¸ƒï¼Œå…¶å‡å€¼éƒ¨åˆ†ä¸ºï¼š


$$
\mu = m x_k + k x_0
$$
å°† $m, k$ å±•å¼€æ•´ç†åï¼Œå¯ä»¥å†™ä¸ºï¼š

$$
\mu = \frac{\sqrt{1 - \bar{\alpha}_s - \sigma^2}}{\sqrt{1 - \bar{\alpha}_k}} x_k

+ \sqrt{\bar{\alpha}_s} x_0 

- \frac{\sqrt{1 - \bar{\alpha}_s - \sigma^2}}{\sqrt{1 - \bar{\alpha}_k}} \sqrt{\bar{\alpha}_k} x_0
$$



å°†ä¸Šå¼åˆå¹¶åï¼Œå¾—åˆ°æœ€ç»ˆå½¢å¼ï¼š

$$
x_s \sim \mathcal{N} \left(
\sqrt{\bar{\alpha}_s} x_0 + 
\frac{\sqrt{1 - \bar{\alpha}_s - \sigma^2}}{\sqrt{1 - \bar{\alpha}_k}} (x_k - \sqrt{\bar{\alpha}_k} x_0), 
\sigma^2 I
\right)
$$



è¿™æ˜¯ **DDIM éé©¬å°”å¯å¤«è·³è·ƒé‡‡æ ·çš„æ ¸å¿ƒé‡‡æ ·å…¬å¼**ã€‚

- å½“ $s = k - 1$ æ—¶ï¼Œé€€åŒ–ä¸ºæ™®é€šçš„é©¬å°”å¯å¤«é‡‡æ ·ï¼ˆDDPMï¼‰ã€‚
- å½“ $s < k - 1$ æ—¶ï¼Œå³ä¸ºè·³è·ƒå¼éé©¬å°”å¯å¤«é‡‡æ ·è·¯å¾„ï¼ˆDDIMï¼‰ã€‚
- å½“ $\sigma = 0$ æ—¶ï¼Œè¡¨ç¤ºç¡®å®šæ€§é‡‡æ ·ï¼ˆno noiseï¼‰ã€‚
- å‚æ•° $\bar{\alpha_s}$,$\bar{\alpha_k}$ æ˜¯ç´¯ç§¯å™ªå£°ç³»æ•°ï¼š  
  $\bar{\alpha_t} = \prod_{i=1}^t\alpha_i$

---

> ğŸ’¡ è¯¥å…¬å¼å¹¿æ³›ç”¨äº DDIM/PLMS/DPM ç­‰æ¨ç†åŠ é€Ÿæ–¹æ³•ä¸­ï¼Œæ˜¯æ‰€æœ‰åŠ é€Ÿå‹æ‰©æ•£æ¨¡å‹çš„æ ¸å¿ƒå…¬å¼ä¹‹ä¸€ã€‚



------

# ğŸ”¥ DDPMä¸DDIMå¯¹æ¯”

> **â€œDDPM ä¹Ÿé¢„æµ‹äº†ä» $x_t$ åˆ° $x_0$ çš„å™ªå£°ï¼ˆÎµï¼‰ï¼Œé‚£ä¸ä¹Ÿç®—æ˜¯ç”¨åˆ°äº† $x_0$ å—ï¼Ÿé‚£ä¸ºä»€ä¹ˆå®ƒè¿˜æ˜¯é©¬å°”å¯å¤«è¿‡ç¨‹ï¼Ÿâ€**



> è™½ç„¶ **DDPM çš„æ¨¡å‹ä¹Ÿé¢„æµ‹äº† $\epsilon_\theta(x_t, t)$**ï¼ˆå¯ä»¥è¿˜åŸå‡º $x_0$ï¼‰ï¼Œ ä½† **DDPM çš„é‡‡æ ·æ­¥éª¤** å¹¶ **æ²¡æœ‰ç”¨åˆ°é¢„æµ‹å‡ºæ¥çš„ $x_0$** â€”â€” å®ƒåªæ˜¯ç”¨é¢„æµ‹çš„å™ªå£°æ¥ç”Ÿæˆä¸‹ä¸€æ­¥çš„ $x_{t-1}$ï¼Œ**è€Œä¸æ˜¯å…ˆè¿˜åŸå‡º $x_0$â€‹ å†æ’å€¼å›å»çš„ï¼**



## âœ… DDPM çš„é‡‡æ ·è¿‡ç¨‹ï¼ˆé©¬å°”å¯å¤«ï¼‰

ä» $x_t$ åˆ° $x_{t-1}$â€‹ çš„é‡‡æ ·æ˜¯ï¼š
$$
x_{t-1} = \mu_\theta(x_t, t) + \sigma_t \cdot z,\quad z \sim \mathcal{N}(0, I)
$$
å…¶ä¸­ï¼š
$$
\mu_\theta(x_t, t) = \frac{1}{\sqrt{\alpha_t}} \left( x_t - \frac{1 - \alpha_t}{\sqrt{1 - \bar{\alpha}_t}} \cdot \epsilon_\theta(x_t, t) \right)
$$


- æ˜¯ä»ä¸€ä¸ª**é«˜æ–¯åˆ†å¸ƒ $p(x_{t-1}|x_t)$** é‡‡æ ·å‡ºæ¥çš„
- åªä¾èµ– $x_t$ å’Œ $\epsilon_\theta(x_t, t)$
- è™½ç„¶é¢„æµ‹äº† Îµï¼Œå…¶ç›®çš„åªæ˜¯ä¸ºäº†æ„é€ è¿™ä¸ªé«˜æ–¯åˆ†å¸ƒçš„å‡å€¼è€Œå·²
- **ä½ å¹¶ä¸ä¼šæ˜ç¡®åœ°è®¡ç®— $x_0$**ï¼Œä¹Ÿä¸ä¼šæ‹¿å®ƒå»æ’å€¼

> æ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯â€œä½ ç°åœ¨åœ¨å“ªã€ä¸‹ä¸€æ­¥å¾€å“ªèµ°â€ â€”â€” çº¯ç²¹çš„é©¬å°”å¯å¤«ï¼

------

## âŒ è€Œ DDIM æ˜¯è¿™æ ·çš„

ä½ ç›´æ¥ç®—ï¼š
$$
x_{t-1} = \sqrt{\bar{\alpha}_{t-1}} \cdot x_0 + \sqrt{1 - \bar{\alpha}_{t-1}} \cdot \epsilon_\theta(x_t, t)
$$
å…¶ä¸­ï¼š
$$
x_0 = \frac{1}{\sqrt{\bar{\alpha}_t}} \left( x_t - \sqrt{1 - \bar{\alpha}_t} \cdot \epsilon_\theta(x_t, t) \right)
$$


$x_t \xrightarrow{\epsilon_\theta}\hat{x}_0\xrightarrow{\text{æ’å€¼}}x_{t-1}$   â¡ï¸ æ˜æ˜¾æ„é€ äº†ä¸€ä¸ªâ€œå…ˆé¢„æµ‹ç›®æ ‡ï¼Œå†å›é€€è·¯å¾„â€çš„ç»“æ„ï¼Œ**ç ´åäº†é©¬å°”å¯å¤«æ€§**

------

## ğŸ”„ æ€»ç»“

> **DDPM çš„ Îµ æ˜¯ä¸ºäº†æ„é€ å±€éƒ¨é«˜æ–¯è½¬ç§»åˆ†å¸ƒ**ï¼Œ
>  è€Œ **DDIM çš„ Îµ æ˜¯ä¸ºäº†è¿˜åŸç›®æ ‡ $x_0$ï¼Œå†ç”¨äºå…¨å±€æ’å€¼é€€å›è·¯å¾„**

å³ä½¿ä¸¤è€…éƒ½é¢„æµ‹äº† Îµï¼Œä½†å®ƒä»¬çš„**ç”¨é€”å’Œç»“æ„ä¾èµ–å…³ç³»å®Œå…¨ä¸åŒ**ï¼š

| ç‰¹æ€§             | DDPM                         | DDIM              |
| ---------------- | ---------------------------- | ----------------- |
| æ˜¯å¦é¢„æµ‹ Îµ       | âœ… æ˜¯                         | âœ… æ˜¯              |
| Îµ çš„ç”¨é€”         | æ„é€  $p(x_{t-1}\|x_t)$çš„å‡å€¼ | è¿˜åŸ $x_0$        |
| æ˜¯å¦æ˜¾å¼ç”¨ $x_0$ | âŒ å¦                         | âœ… æ˜¯              |
| æ˜¯å¦é©¬å°”å¯å¤«è¿‡ç¨‹ | âœ… æ˜¯                         | âŒ å¦              |
| æœ¬è´¨å¯¹åº”         | éšæœºè¿‡ç¨‹ï¼ˆSDEï¼‰              | ç¡®å®šæ€§è¿‡ç¨‹ï¼ˆODEï¼‰ |



# ğŸ”¥æ ¸å¿ƒä»£ç 

>DDPMå’ŒDDIMåªæ˜¯åœ¨é‡‡æ ·æ—¶ä¸åŒï¼Œè®­ç»ƒçš„æ—¶å€™æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼ï¼

```python
import torch
from forward_noising import (
    get_index_from_list,
    sqrt_one_minus_alphas_cumprod,
    betas,
    posterior_variance,
    sqrt_recip_alphas,
    alphas_cumprod,
    alphas_cumprod_prev
)

import matplotlib
matplotlib.use('Agg')  # ä½¿ç”¨éäº¤äº’å¼åç«¯

import matplotlib.pyplot as plt
from dataloader import show_tensor_image
from unet import SimpleUnet
from forward_noising import T
from training_model import epochs
import numpy as np

@torch.no_grad()
def sample_timestep_ddim(model, x, t, eta=0.0):
    """
    DDIM deterministic sampling step.
    """
    alpha_cumprod_t = get_index_from_list(alphas_cumprod, t, x.shape)
    alpha_cumprod_t_prev = get_index_from_list(alphas_cumprod_prev, t, x.shape)

    sqrt_alpha_cumprod_t = torch.sqrt(alpha_cumprod_t)
    sqrt_alpha_cumprod_t_prev = torch.sqrt(alpha_cumprod_t_prev)
    sqrt_one_minus_alpha_cumprod_t = torch.sqrt(1 - alpha_cumprod_t)

    # Predict noise
    eps_theta = model(x, t)

    # Predict x0
    x0_pred = (x - sqrt_one_minus_alpha_cumprod_t * eps_theta) / sqrt_alpha_cumprod_t
    x0_pred = torch.clamp(x0_pred, -1.0, 1.0)

    # Compute sigma and noise
    sigma = eta * torch.sqrt(
        (1 - alpha_cumprod_t_prev) / (1 - alpha_cumprod_t) *
        (1 - alpha_cumprod_t / alpha_cumprod_t_prev)
    )
    noise = torch.randn_like(x) if eta > 0 else 0

    # Compute direction pointing to x_t
    dir_xt = torch.sqrt(1 - alpha_cumprod_t_prev - sigma**2) * eps_theta

    x_prev = sqrt_alpha_cumprod_t_prev * x0_pred + dir_xt + sigma * noise

    return x_prev



@torch.no_grad()
def sample_plot_image_ddim(model, device, img_size, ddim_timesteps, eta=0.0):
    img = torch.randn((1, 3, img_size, img_size), device=device)
    plt.figure(figsize=(15, 15))
    plt.axis("off")
    num_images = 10
    stepsize = max(1, len(ddim_timesteps) // num_images)

    for i, step in enumerate(reversed(ddim_timesteps)):
        t = torch.tensor([step], device=device, dtype=torch.long)
        img = sample_timestep_ddim(model, img, t, eta=eta)
        img = torch.clamp(img, -1.0, 1.0)

        if i % stepsize == 0:
            plt.subplot(1, num_images, i // stepsize + 1)
            show_tensor_image(img.detach().cpu())

    plt.savefig("sample_ddim_steps=%d_eta=%.1f.png" % (len(ddim_timesteps), eta))


if __name__ == "__main__":
    img_size = 64
    model = SimpleUnet()
    device = "cuda:1" if torch.cuda.is_available() else "cpu"
    print(f"Using device: {device}")
    save_path = "./trained_models/ddpm_mse_epochs_%d_T_%d.pth" % (epochs, T)
    model.load_state_dict(torch.load(save_path))
    model.to(device)

    # è®¾ç½®é‡‡æ ·æ­¥æ•°
    ddim_steps = 50
    ddim_timesteps = np.linspace(0, T - 1, ddim_steps, dtype=int)

    # å¼€å§‹é‡‡æ ·
    sample_plot_image_ddim(model=model, device=device, img_size=img_size,
                           ddim_timesteps=ddim_timesteps, eta=0)

```

